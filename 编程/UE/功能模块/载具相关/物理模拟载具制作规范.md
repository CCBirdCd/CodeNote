# 载具模型-组件相关
![[编程/UE/功能模块/载具相关/Image/物理模拟载具制作规范/5461748dfb106d2ff13f100516854781_MD5.png]]
## 1.基础组件
RootCapssuleMesh：根胶囊体组件，位于载具最前方，尽量包含住载具车头整个部分，如果不想有额外的碰撞就尽量在包含住载具前半部分模型的前提下尽可能的缩小，是移动碰撞的基础组件，胶囊体底部需要和轮胎在同一平面，胶囊体半径不能过小最好在 25 以上，否的可能会导致判断出现问题
RootCapssuleMeshFront：需要和 RootCapssuleMesh 保持同样的位置和大小，主要用于修改载具角度
RootCapssuleMeshBack：和 RootCapssuleMesh 不同的是  RootCapssuleMeshBack要做的是尽可能的包含住载具尾部的那部分，主要用于载具的尾部碰撞检测，胶囊体底部需要和轮胎在同一平面
RootSkeletalMesh：载具模型挂载组件
VehicleSplineMoveCmpt：是载具曲线移动组件，需要通过触发器之类的手段调用组件接口将 spline 曲线设置给该组件
MovementComponent：基础移组件
## 2.拓展组件（TS用）
上图如  WayPoint,Niagara之类的组件写在Ts里，添加顺序是在 蓝图里添加完组件后到Ts里声明同名组件然后使用，这部分修改涉及程序逻辑需要程序添加，策划不应该自行添加
# 载具动画
等舒宁有时间写一下再补充
# 人物动画
## 1.上下车载具动画
目前上下车使用的是蒙太奇动画，制作要求是，人物站在面朝向载具侧面的位置播放动作旋转90度之后，刚好位移到载具的座位上，下车同理要求带着人的胶囊体离开载具位置

![[编程/UE/功能模块/载具相关/Image/物理模拟载具制作规范/fb8cd3480333bc1b0b1f33c6e06d4981_MD5.png]]![[编程/UE/功能模块/载具相关/Image/物理模拟载具制作规范/bdab21418113aebfa0d674484412fde0_MD5.png]]
人物动画制作之后需要添加隐藏武器曲线，把曲线值改为1，如下图：
![[编程/UE/功能模块/载具相关/Image/物理模拟载具制作规范/0f144711d54ea162d5b001d118dfcc35_MD5.png]]
![[编程/UE/功能模块/载具相关/Image/物理模拟载具制作规范/6238cd72de7d33e00fcfc84e7f6c290f_MD5.png]]
# 特殊功能制作方案
## 1.碰撞飞出效果
描述：载具碰撞到可以撞飞的物体后，产生碰撞时被撞击物体收到物理的力直接飞出之类的效果，即模拟物理碰撞效果
要求：载具的胶囊体 碰撞预设设置成 Vehicle 类型，如下图：
![[编程/UE/功能模块/载具相关/Image/物理模拟载具制作规范/187d31fdb6bc0060be75229e71d5a92e_MD5.png]]

但是载具模型组件碰撞预设不能设置成 Vehicle,暂定设置成Pawn（如果之后有其他需求可能会单独出一个类型），如下图：
![[编程/UE/功能模块/载具相关/Image/物理模拟载具制作规范/a0c88cf2e904d1a64256a5256422602b_MD5.png]]

然后可以被碰撞产生物理效果的物体需要设置碰撞通道忽略Vehicle且设置Pawn（也可能是一种特殊的类型）为Block，通过Mesh产生的碰撞效果实现模拟物理碰撞
# 载具参数相关
## 载具参数配置位置
![[编程/UE/功能模块/载具相关/Image/物理模拟载具制作规范/ed29dcc52cb10530bae4ba2ff0da1cfa_MD5.png]]
现有的配置，部分是读取的固定配置行数据，因为之后正式可能会拆分模块，数据结构届时可能会有较大变动，所以Demo暂时没写那部分的配置逻辑
### 1.动画参数
![[编程/UE/功能模块/载具相关/Image/物理模拟载具制作规范/d88a20f3cfa9b0f8d9d3b25719bf5775_MD5.png]]
![[编程/UE/功能模块/载具相关/Image/物理模拟载具制作规范/4f1bd33d34e4a973827720d0161e25fa_MD5.png]]
目前针对二轮单座摩托来说需要配置的动画主要有五个，四个蒙太奇，一个动画序列，分别是：		   	  
getInLeftMontage:左侧上车动画			
getInRightMontage:右侧上车动画			
getOutLeftMontage:左侧下车动画		
getOutRightMontage:右侧下车动画		
StartCarSequence:上车之后的打火动作
目前默认读取rowname为byk的行数据，之后多角色会根据配置读取对应动作（正式还会划分上车点之类的需要策划定下）
### 2.音效参数
![[编程/UE/功能模块/载具相关/Image/物理模拟载具制作规范/fcff73da550017dcf51bd270998528a0_MD5.png]]
![[编程/UE/功能模块/载具相关/Image/物理模拟载具制作规范/27bc6d88363c9d1f87e75404b1ff9900_MD5.png]]
现在载具需要配置的声音有如下：
eventFire:摩托车启动音效 event，一般是上车之后打火后出现的声音（是一种怠速的的声音在载具上的时候一直有声音）
eventDriving:载具行驶的音效 event
eventStopDriving:关闭载具行驶音效 event
eventRub:刹车音效播放event
eventStopRub:停止播放刹车音效的 event
eventGear:载具换挡音效 event
eventHitWall:载具撞击墙面的 event
eventFlyToGround:载具飞车落地音效 event
rtpcSpeedUp:更新载具行中驶音效效果的 rtpc 参数控制
rtpcLoad:载具行驶时按住加速按键 和 松开加速按键需要同个这个 rtpc 来更新音效效果
rtpcTurnDirection:载具转向时调用的 rtpc 来实现模拟转向音效
rtpcFlyToGround:载具飞车落地的时候通过高度控制声音效果的 rtpc 参数
materialSwitch:材质音效配置，根据不同的材质配置不同的 switch 开关
groupName:材质音效组 名称 配合 materialSwitch 使用
现在摩托默认使用 criuser 行配置
### 3.载具配置参数
![[编程/UE/功能模块/载具相关/Image/物理模拟载具制作规范/d6389d2254faa4f626495f0563561ca5_MD5.png]]
#### 3.1 载具通用参数 VehicleParam
![[编程/UE/功能模块/载具相关/Image/物理模拟载具制作规范/3c4e73209166ffb5a36ad50d40dfc148_MD5.png]]
以上参数需要注意的是：
1.载具座位信息的座位插槽 需要建立在Root骨骼节点下，原因是：载具转向倾斜时人物也会通过动画跟随倾斜，如果此时座位插槽跟随载具倾斜的话 就会导致人的倾斜角度是车的两倍，导致穿帮，而且目前由于偏移的问题位置需要根据实际情况来调整，不精确在座位上（目前猜测可能和胶囊体绑定点有关），座位插槽偏移目前是预留参数暂时没用上，目前座位逻辑是登上最近的插槽座位![[编程/UE/功能模块/载具相关/Image/物理模拟载具制作规范/278a20e9a5f5645bff4dc488b78b9fa4_MD5.png]]
2.载具轮胎信息需要注意的是二轮载具默认添加顺序是 （前轮，后轮），四轮载具之后规划为（左前，右前，左后，右后）
#### 3.2 载具动画参数 AnimParam
![[编程/UE/功能模块/载具相关/Image/物理模拟载具制作规范/8496a08425226e4efda956549602637e_MD5.png]]
目前需要配置的曲线是 车身倾斜曲线(x-速度km/h, Y-角度 度/秒)
#### 3.3 粒子特效参数 NiagaraParam
![[编程/UE/功能模块/载具相关/Image/物理模拟载具制作规范/5dc8225a4535a8bca70e1aa873730e79_MD5.png]]
![[编程/UE/功能模块/载具相关/Image/物理模拟载具制作规范/7d2648f303169f79a5e9f1e22016e19e_MD5.png]]
基本大部分特效都是和材质挂钩的，需要特别注意的是 WheelDriftMarkNiagara 和 WheelRunMarkNiagra是载具漂移和行驶地面上时留下的痕迹，需要和载具轮胎数量对应且顺序也对应，相同索引的轮胎和特效是匹配的、NEngineSmoke:载具启动打火的时候喷烟特效、NEngineFire:载具换挡喷火特效
#### 3.4 载具速度参数 SpeedParam
![[编程/UE/功能模块/载具相关/Image/物理模拟载具制作规范/4fd1e5cb5cc5af3fe18cf6674c1bbd7a_MD5.png]]
![[编程/UE/功能模块/载具相关/Image/物理模拟载具制作规范/8da6b74f51a82a28a0521271fc2fc927_MD5.png]]
部分不易理解参数解释如下：
加速换挡点：加速超过这个速度时会触发一次自动升档逻辑
减速换挡点：减速低于这个速度时会触发一次自动降档逻辑
更新行驶中音效间隔参数：这个是为了使音效效果听起来更加的真实通过rtpc修改音频参数，每次速度累计增加超过该速度时修改一次音频效果参数
载具正/背面下直角坡额外速度：前进/后退低速下直角斜坡的时候避免悬空下坠造成穿模现象给与的额外速度
载具头/尾贴合墙面最大转轮速速：主要载具贴合墙面的时候使用，限制其最大速度增长，但是也不能太小，不然载具无法正常转向离开墙面
载具低速撞墙特殊逻辑处理临界速度：配合低速载具低速撞墙特殊处理临界角度使用，载具碰到墙面时速度大于此速度则走通用撞墙逻辑，小于此速度和临界夹角时则走特殊逻辑处理为了方便离开墙体
低速下直角坡重力加速度：在载具从地面到完全滞空之间使用的重力加速度，要小于正常重力加速度 增加滞空时间，避免快速下落导致明显穿模现象
载具最大左右倾斜角度：载具最大翻滚角（目前策划要求摩托没有翻滚角倾斜）
地面摩擦力减速度：地面自然带来的摩擦力减速度（这个目前是一个保底参数，实际的摩擦力减速度应该由曲线来配置和坡度相关）
刹车制动减速度：玩家手动减速使用的额外减速度
漂移减速度：玩家漂移的时候适用的减速度
载具低速贴墙特殊处理横向偏移速度：属于特殊处理参数，在载具贴墙时为了使载具更加容易离开墙面而施加的一个垂直于墙面的速度，方便载具离开墙体，不宜过大
坡度摩擦力减速度曲线：正常配置情况下使用的地面摩擦力曲线（玩家路线坡度即载具俯仰角(X) - 摩擦力减速度 m/s² (Y)）
坡度最大速度系数曲线：载具在不同地形下的最大限制速度（玩家路线坡度即载具俯仰角(X) - 最大速度系数 (0-1] (Y)）配合最大速度使用
载具当前加速度曲线：载具在不同速度下最大加速度系数 （载具当前速度(X) - 最大加速度系数 (0-1] (Y)）配合最大加速度使用
载具坡度减速度：在不同坡度下重力加速度实际应用值系数 (当前坡度角度(X) - 重力加速度系数(Y)) 配合最大重力加速度使用
载具前进/后退转向角：载具在前进和后退时转向能力曲线 （载具速度 km/h(X) - 转向角(Y)）
载具俯仰角调整插值：以图为例，单次载具俯仰角变化绝对值在【0，5】之间使用5配置的插值系数曲线，在（5，无穷大] 之间使用 10 配置的线，曲线意义：载具速度 km/h(X) - 插值速度(0-1)(Y)，针对载具来说越接近 1 则载具越趋近于真实数据变化，带来的反面效果是抖动显得比较剧烈
载具可行驶上的最大高度：能行走上的坡度计算参数，基本不用改，数据来源参照了人物移动
#### 3.5 载具飞出参数 FlyParam
![[编程/UE/功能模块/载具相关/Image/物理模拟载具制作规范/14f17089b299a8ef8d0c45312287885c_MD5.png]]
载具起飞高度：单次计算位移差值大于此值得时候载具尝试进入飞出坠落模拟
空中每秒自动调整翻滚角度：载具在飞出的会自动调整翻滚角到 0，此参数是角度调整速度
飞车时载具最大俯/仰角：载具在飞出后会自动过渡到配置角度
空中没秒自动调整俯仰角度：俯仰角调整速度
空中调整旋转角最大角度：在空中改变载具姿态最大角度，用来调整载具转向
载具安全落地最大角度：落地时和地面夹角如果超过该角度则载具直接走碰撞销毁逻辑
落地弹性减速最小高度：在空中落地时如果坠落高度超过这个高度则载具进行弹性减速逻辑
落地减速比例：范围（0-1）触发弹性减速后速度乘以该系数
空中调整角度不漂移最大角度：在空中时调整载具转向角度小于此配置角度时，落地瞬间速度和载具的朝向一致，否则在落地后载具会进行一小段漂移使速度回归到载具朝向
载具后退下断崖式斜坡车身模拟翻转调整角度： 属于特殊参数，由于胶囊体在前方使用此参数控制 模拟载具 车身翻转速度
#### 3.6 载具碰撞参数 HitParam
![[编程/UE/功能模块/载具相关/Image/物理模拟载具制作规范/4144745d79107d61ef2c5a508e5e788e_MD5.png]]
载具撞飞判定曲线：X：载具速度   Y：碰撞角度，判定载具在当前速度下碰撞墙面时形成夹角如果超过配置夹角，可以认为是触发载具撞毁逻辑，反之走碰撞修正逻辑
载具角度修正曲线：垂直速度分量(X)-载具修正角度(Y) ,载具碰撞后速度方向修正曲线
载具水平速度衰减曲线：垂直速度分量(X)-衰减比例(Y),载具碰撞后水平速度衰减曲线,碰撞后水平速度乘以该曲线对应系数，设定为新的速度、
载具碰撞弹回曲线：垂直速度分量(X)-弹回距离(Y)，载具碰撞后弹回距离，瞬间弹回所以距离不可以配置太大（单位是m）
载具撞墙每秒修正角度：载具撞墙后只剩沿着墙面的水平速度，但是载具的朝向需要逐渐过渡过去，此参数是过渡速度
载具撞墙水平修正角度：载具撞墙后计算最终平行于墙面的水平速度额外旋转角度，方便载具离开墙面
载具坡道滑落角度：坡面角度大于该角度时进入坡面滑落状态
载具碰撞判定角度：碰撞墙体时夹角大于此角度进入碰撞判定逻辑
载具碰撞激活摩擦粒子特效角度：碰撞墙面且夹角小于此角度时激活摩擦墙面粒子特效
载具低速撞墙特殊处理临界角度：配合载具低速撞墙特殊逻辑处理临界速度使用
载具低速撞墙修正角度：低速撞墙时在速度修正到水平后的基础上再次累加的额外偏转角度
播放碰撞动作最小速度播放载具碰撞动作的最小临界速
#### 3.7 漂移参数 DriftParam
![[编程/UE/功能模块/载具相关/Image/物理模拟载具制作规范/68b1fb87596e08d56cbceb87e3d5fe3c_MD5.png]]
载具漂移额外附加转向角曲线 ：(x-速度km/h, Y-角度 度/秒)  漂移时为了模拟漂移效果，载具额外的转向角
载具漂移速度回归曲线：(x-速度km/h, Y-角度 度/秒) 载具在不同速度下漂移速度回归效果（指速度逐渐过渡到载具方向）
载具最小起飘速度：能达到漂移条件的最小速度
#### 3.8 射线检测参数 LineTraceParam
![[编程/UE/功能模块/载具相关/Image/物理模拟载具制作规范/ff694fe266059fe06768a5f88b983445_MD5.png]]
![[编程/UE/功能模块/载具相关/Image/物理模拟载具制作规范/6cf8784656ad35f7f70b8c7b07253dd2_MD5.png]]
以下参数一般由程序来调整：
前轮向前射线起始点偏移：载具射线检测墙面时基础射线位置偏移数据（以摩托为例是在 轮胎中心骨骼节点的世界坐标上加上额外偏移，暂时只用来调整Z轴高度，避免从骨骼节点打出的射线过低影响判断）
后轮向后射线起始点偏移：同上
前轮射线检测墙面距离：预检测距离，提前检测前方一定距离的墙面参数
后轮射线检测墙面距离：同上
载具前面球形检测半径：上图球形检测的半径
载具后面球形检测半径：同上
#### 3.9 减震参数AbsorbShockParam
![[编程/UE/功能模块/载具相关/Image/物理模拟载具制作规范/9b72a6dc02aa6bd4bb7fff47dad0e74b_MD5.png]]
目前减震模拟是由程序算减震结果，然后动画里调整载具骨骼偏移来实现的，现在实现的摩托减震结构是：前轮只调整骨骼位置，后轮调整轮胎位置和尾部角度
前轮减震结构：通过调整骨骼偏移模拟实现 伸缩管式减震 
前轮向上调整最大高度：限制前轮向上调整的最大值
前轮向下调整最大高度：限制前轮向下调整的最大值
前轮向上自动恢复高度：模拟向上实现减震恢复的速度
前轮向下自动恢复高度：模拟向下实现减震恢复的速度
![[编程/UE/功能模块/载具相关/Image/物理模拟载具制作规范/114b02a930e2487c251914853bd3b4ca_MD5.png]]
![[编程/UE/功能模块/载具相关/Image/物理模拟载具制作规范/db87e7afdbc4472092795899923a4353_MD5.png]]
后轮减震结构：通过调整后轮骨骼角度来实现减震效果，要求是减震骨骼能够带动轮胎一起旋转
后轮向上调整高度：针对下图减震结构，此参数无用（暂时保留，看之后其他减震结构能否使用上）
后轮向下调整高度：针对下图减震结构，此参数无用（暂时保留，看之后其他减震结构能否使用上）
后轮减震向上调整最大角度：限制尾部减震结构向上旋转角度最大值
后轮减震向下调整最大角度：限制尾部减震结构向下旋转角度最大值
后轮向上自动恢复角度：模拟向上角度自动恢复速度
后轮向上自动恢复高度：针对下图减震结构，此参数无用（暂时保留，看之后其他减震结构能否使用上）
后轮向下自动恢复角度：模拟向下角度自动恢复速度
后轮向下自动恢复高度：针对下图减震结构，此参数无用（暂时保留，看之后其他减震结构能否使用上）
![[编程/UE/功能模块/载具相关/Image/物理模拟载具制作规范/b6294db0ab5cd15e46e699dd31504b01_MD5.png]]
#### 3.10 扬尘参数配置SmokeConfig
![[编程/UE/功能模块/载具相关/Image/物理模拟载具制作规范/e8711a091232215718c56ae0550ec51c_MD5.png]]
特效给出的调整扬尘效果的参数，包含粒子生成空间 和 随机最大最小值  
# 载具镜头模式
## 1.换挡配置
![[编程/UE/功能模块/载具相关/Image/物理模拟载具制作规范/d702725aaa222e94da074c84e92881ce_MD5.png]]
是否开启：勾选则开启，反之则不开启
镜头臂长拉伸速率：臂长的插值速度 和 显示参数无关，值域最好在 50 一下，不然可能导致拉伸效果过快出现闪现现象
镜头臂长恢复速率：同上
拉伸距离：此距离不是最终拉伸效果距离，在最终的目标距离上加上 该值计算出来的插值，然后进行插值（原理：对拉伸距离进行插值，然后将插值结果加算到臂长插值计算，如果拉伸距离的插值达到目标值则开始收缩插值臂长，取当前值归零的负值作为额外拉伸臂长参与计算）
镜头视野拉伸速率：原理镜头臂长拉伸速率
镜头视野恢复速率：原理同上
视野：原理同拉伸距离
## 2.载具前进启动效果
![[编程/UE/功能模块/载具相关/Image/物理模拟载具制作规范/8a38959548abdaa90d8f241dcfe340c3_MD5.png]]
参考换挡配置
## 3.载具后退启动效果
![[编程/UE/功能模块/载具相关/Image/物理模拟载具制作规范/9f7532dba7216da932d24fae4824818c_MD5.png]]
参考换挡配置
## 4.载具相机配置
![[编程/UE/功能模块/载具相关/Image/物理模拟载具制作规范/1306c0313998754236fe2f1ca63a63d3_MD5.png]]
载具静止状态时间检查：载具停止超过该配置时间，默认为载具静止，再次启动时镜头自动跟随
载具相机最短臂长：用于处理镜头力臂碰撞问题，碰撞导致臂长小于此值时开始调整载具的视点偏移
碰撞镜头拉伸速率：单位（cm/s）碰撞镜头 Z 轴调整速度
相机/相机Fov拉远/近速率：插值速度 和 参数无关，值域最好在 50 一下，不应过大
载具相机前进目标臂长：前进时随速度改变臂长（速度为零的时候基础值应该和载具默认臂长保持一致）
载具相机后退臂长：后退时随速度改变臂长（速度为零的时候基础值应该和载具默认臂长保持一致）
载具相机目标Fov曲线：初始值和默认值要保持一致，不然上车会有fov变化，看需求

