# 角色八向运动
## 1.简单的介绍与思路梳理
八向移动，指的是角色拥有向前后左右，左前，左后，右前，右后移动的动画。当角色的控制器旋转（可以将控制器旋转近似地理解为一个指向特定方向的单位向量）与角色的速度向量之间产生了一定大小的夹角后，角色的动画需要发生相应的变化。
举两个例子，一个是速度方向不变，控制器方向旋转：比如当前角色在我们按住“W”时，沿着x轴（世界坐标系下的）直线向前跑，此时我们旋转鼠标，令控制器向右旋转至y轴（世界坐标系下的），那么角色做出一个向右前方跑动的动作才会显得自然（此时w还是一直按着）。
![[编程/UE/功能模块/Image/角色动画相关/0d8058df7ccfc95c17eb62b5e642f75f_MD5.png]]
你瞅啥？
另一个例子是控制器方向不变，速度方向改变：还是当前角色在我们按住“W”时，沿着x轴（世界坐标系下的）直线向前跑，此时我们在按住“W”不放时，再同时按下“D”，且鼠标保持不动。那么角色同样要做出一个向右前方跑动的动作才会显得自然。
在这两个例子中，角色的跑动动画从向前变成右前的原因都是相同的：控制器和速度方向的变化，引起了控制器和速度夹角的改变。因此我们要更改动画，以体现出这种改变。
于是，想要实现八向移动，我们要做的事情就很明了了——在每帧都计算出角色速度和控制器旋转之间的夹角，并用它来更新动画。
## 2.传统做法及其问题所在
计算出角色速度和控制器旋转之间的夹角可以用下面的这个节点：
![[编程/UE/功能模块/Image/角色动画相关/ea7eab43dcad4c22141b76394cf7b045_MD5.png]]
UE，真的贴心，手把手教你做动画了属于是
因为涉及到了角度的连续的变换，一个自然的想法就是使用混合空间，在一个坐标轴中设定为-180~180度，在其中分布八向移动的各个动画。
（由于Advanced Locomotion System4中没有额外制作正右和正左动画，因此这里我就少放两个动画序列凑合了。）
![[编程/UE/功能模块/Image/角色动画相关/2d0126ee5296ca243ae8cb5ea1bdabdc_MD5.png]]
不过准确的说是ALS4没有制作右前和左前动画，顶着右前和左前名字的动画序列中实际上里面装着的是正右和正左，想要做出右前和左前动画效果需要自己手动混合。右后和左后看起来也像是直接反向播放的结果。
这个想法很自然，然而由于混合空间自身的性质，决定了这个方案无法实行。
简单来说问题就在于“跳变”，比如左到右会跳变（右到左也会）。这个问题稍小一点（原因是只跳变了180度），通过谨慎地选择混合时间可以勉强解决这个问题——混合时间短会使得跳变时的动作快速切换导致的变形更加明显，而混合时间长会使得角色左右切换时出现中间的两步向正前方“原地踏步”。
而更严重的问题是左后到右后的跳变（右后到左后也会跳变）。乍看起来，左后和右后两个动作的差距不算多大，按理说混合起来应该很自然才是。
然而混合空间的眼中并不是左后和右后两个动作在混合，而是远在坐标轴最左侧的动画要混合到远在坐标轴最右侧的动画。
它会在用户规定的混合时间内把坐标轴上的动画挨个混合过去，因此最终实际体现出来的效果就是角色在向后移动时，每次鼠标左右动一些，角色就像是抽搐了一下——极度不自然。（即使把轴从-180~180改为0~360也无济于事，那样只是让抖动从向后走时变成向前走时而已）
如果混合空间可以支持一个“环形”的数轴就好了。可惜目前并不支持，只能处理直线的轴。因此我们只能使用状态机来解决跳变问题。
## **3.ALS4采用的使用动画状态机来实现八向移动**
### **3.1计算移动意图**
在传统方法中，角色速度与控制器夹角是多少，就采用与之相应的移动动画。在动画状态机中，我们为了克服跳变导致的不自然，我们不能使用这么直接的方式。
我们不能直接用夹角的区间来代表使用哪一种动画，这个夹角只会用于表示“**移动意图**”，具体采用哪一种动画序列，需要结合移动意图和角色当前使用的动画序列综合决定。
**移动意图**：只有前后左右四个方向。通过角色的速度方向与控制器的旋转之间的夹角计算得到。我们规定控制器与角色的速度方向夹角在-70~70度为前，70度~110度为右，-70度~-110度为左，剩下为后。
![[编程/UE/功能模块/Image/角色动画相关/e9227104d5c15069afcfd3170def9fbb_MD5.png]]
显然，移动意图和世界坐标系是无关的，只和玩家自身的坐标系有关。我们可以写一个函数来判断角度处在前后左右四个区间（或者说是象限）中的哪一个：
![[编程/UE/功能模块/Image/角色动画相关/1c0dd991c6095672dbe3d4f78e303b67_MD5.png]]
函数的核心内容的截图
缓冲区这个参数用于动态的扩大或者缩小象限的范围。当角色目前的移动意图为左或右时，就会将前后的角度区间扩大，缩小左右象限的角度区间。反之亦然。
将角色控制器与角色速度的夹角计算象限的函数内，就可以得到角色接下来的移动意图。至于这个夹角怎么计算，ALS4中是这么做的：（AimingRotation存储了角色控制器旋转）
![[编程/UE/功能模块/Image/角色动画相关/74584b50ba66cd1bfa9e4a78513931bd_MD5.png]]
不过前面我们也说了，UE内置了方便的函数（计算方向）：
![[编程/UE/功能模块/Image/角色动画相关/a2b13034c4ef5f9998228ddad3342ad5_MD5.png]]
这两种做法的效果是等价的，读者可以自行实验验证。
### **3.2制作八向移动的动画状态机**
如图所示，所有黄色的过渡条件都是“移动意图==向前”，绿色的过渡条件是“移动意图==向后”，红色是向右，蓝色是向左。（拥有相同的颜色是因为用了共享的过渡规则）
![[编程/UE/功能模块/Image/角色动画相关/7b611a537ccb8a0c6e9e7b728e7c1d52_MD5.png]]
这个状态机解决了使用传统方法的混合空间时产生的跳变问题。简单的说说这个状态机搭建的一些思路：
外围的这个红色圈应该很好理解，按住W，WD，D，SD，S，这样一个按键顺序，就能实现从Move-F，Move-FR，Move-BR，Move-B的状态节点的移动。如果直接从按住W变成按住S，那走的就是中间的那条红色直径，直接从Move-F变到Move-B。
![[编程/UE/功能模块/Image/角色动画相关/3d6bdf2b713deda9e2f3f8e8fc34a6eb_MD5.png]]
我们着重说说中间两条橘色的过渡条件的用意所在。
在混合空间中，如果要实现从右前到左后的切换，会由于跳变了180度，要把半条坐标轴上的动画序列混合过去（放在这个状态机中则体现为绕着红色的圆周跑了半周），会显得不那么自然。因此我们为了使得右前与左后的动画可以直接进行混合，而无需“绕着圆周跑半周”，特地增添了这条橘色的直径，使得发生180度跳变时，可以直接与目标动画混合。
仔细观察就能发现，这个状态机中一共有三条直径，都是为了处理180度跳变时的混合而设计的。
那360度的跳变呢？这由于动画状态机中的状态节点可以连成一个环形，因此不攻自破了。

另外值得一提的是，**八**向移动的动画状态机中却只有**6个**状态节点，但是这却并不会影响。要做成8个状态节点（实际上应该是10个，正左和正右实际上要分是正着走还是倒着走，或者说是胸口的朝向与移动方向是否一致）的话也行，这需要在计算移动意图时更下功夫，移动意图不能只有前后左右这四个枚举值，而需要有确确实实的八个方向的枚举值。自然，这样的判断也会变得更繁琐。在状态机中，过渡条件也会因此而从原先的4个组分成8个组。连接的思路和上面类似，感兴趣的读者可以自己尝试尝试。
为啥这种只有6个状态节点的八向移动状态机也能正常运作呢？
我们前面提到，ALS系统中的向右前动画，只是名字叫右前而已，实际装着的是胸口向右的向正右移动的动画。（角色此时是在正着走）
![[编程/UE/功能模块/Image/角色动画相关/07a64bf9b182f9c7a32f420ad8386e3a_MD5.png]]
而向右后动画，则是背部向右的向正右移动的动画。（没错，怎么看都很像是把胸口向左的向左移动动画给逆序播放了= =角色此时是在倒着走。）
![[编程/UE/功能模块/Image/角色动画相关/34baf2eb8f0361df0f80b78530589d0d_MD5.png]]
ALS4眼里的右前并不是“向右前方移动”，而是胸口（身体的前面）向右的向右移动，同理右后也是背部（身体的后面）向右的向右移动。
因此，这个只有**六个**状态节点的状态机，**里面看起来是没有“正左和正右”，实际上是只有“正左正右”，没有左前左后，右前右后。**
如果先按住W，再松开W,按住A，就会来到FL节点处，处于“身体的前方向左”的正左移动。这时再松开A，按住D，就会沿着橘色的直径来到BR节点——“身体的前方向左”的正右移动。
![[编程/UE/功能模块/Image/角色动画相关/3d6bdf2b713deda9e2f3f8e8fc34a6eb_MD5.png]]
这就体现出这种设计的好处之一——在左右切换这种剧烈的180度跳变时，**角色的胸口朝向是不会变的**，不会出现角色的胸口转了个180度的情况。
有读者就要问了，那说好的右前右后，左前左后去哪了？答案是在Move-F或Move-B节点中进行混合得到的。至于具体怎么个混合法，用到的混合度应该如何计算，我们下一节再说。
### **3.3计算速度混合度**
移动意图解决的问题是在状态节点中的转换，而速度混合度解决的问题是在状态节点内的动画混合。
计算速度混合度主要要用到角色的相对速度，这一概念和移动意图需要做一下区分。角色的相对速度指角色当前时刻中相对自身坐标系的移动方向，而移动意图指的是角色下一时刻倾向于的移动方向。
此外，移动意图只分为前后左右四个值，无法实现速度混合度的精细混合要求。

速度混合度实际上是将角色的相对速度沿角色坐标系的XY轴正交分解，得到角色相对速度在X和Y轴上的分量。由于角色坐标系下的XY轴实际上就是指前后左右，因此这个分量就指出了角色当前向左（右）移动的程度和向前（后）移动的程度。
![[编程/UE/功能模块/Image/角色动画相关/1b9c567fbf00cf4338c91f0ac3f14d0d_MD5.png]]
将相对速度的x分量和y分量除以(x^2+y^2)的根号，赋值为相对X和相对Y。
![[编程/UE/功能模块/Image/角色动画相关/594a5f3b2cf9493256941ccd7222dc04_MD5.png]]
如此，速度混合度就计算完成了。
然后还要再写一个对速度混合度进行插值，在角色移动状态变换时可以平滑的过渡的函数。源速度混合度是上一帧的旧数据，目标速度混合度是这一帧的新数据。
![[编程/UE/功能模块/Image/角色动画相关/e4503b881349a399bc5545ad0a4c12ad_MD5.png]]
下面是在状态节点中的运用。
将角色向前，后，左前，右前的动画进行多引脚混合。这里使用了缓存姿势来将动画序列作为“变量”来存储，使得要替换动画序列时不需要改动动画状态机。只用改变传入的姿势就行。
![[编程/UE/功能模块/Image/角色动画相关/5234eff29ce8ef64cb0197581652f5f4_MD5.png]]
而在FR节点中，Left方向的动画却不能采用LF，而要用LB。原因是我们上面说的，在左右180度跳变的时候我们希望胸口的朝向不要改变，因此要使用LB动画（也就是倒着走，胸口朝右的向左移动动画）
![[编程/UE/功能模块/Image/角色动画相关/528a883b8d95a3cb9c878bf9e82ceff8_MD5.png]]
同样的，在BL节点中，和上图也一模一样。
在FL和BR节点中则长这样：
![[编程/UE/功能模块/Image/角色动画相关/b568343ad641e7e432e8c95cc137c3e8_MD5.png]]
在Move-B节点中，L与R的动画姿势用LB与RB。
我们以一个FR节点跳变到BL节点来举例说明这个状态机的混合。
在角色移动状态改变的瞬间，移动意图会立刻变化，状态机会从FR节点移动到BL节点，过渡条件会自动将两个节点中的输出姿势进行混合。而由于速度混合使用了插值，此时即使状态机已经发生了状态节点的跳动，速度混合自身却还在均匀的变化（R此时还没降到0，L此时还没升到1）。
因为FR节点和BL节点中的用的姿势都是一模一样的，而跳变过去时速度混合度也还没来得及发生多少变化，所以此时BL节点的输出姿势其实和FR节点差不了多少。换言之，过渡条件要混合的两个状态节点之间的输出姿势很相似，因此混合起来会比较自然。
然后在BL节点内，随着速度混合的插值，BL节点输出的姿势也会逐渐的从胸口向右的右行动画转变为胸口向右的左行动画。
这样，一次自然均匀的动作切换就完成了。（其实这样做还是不够自然，还有一些其他工作要做，不过先暂时更新到这里，剩下的后面再说= =）
另外，上文没有提到的是缓存姿势中输入的姿势应该是长啥样的，这里简单提一嘴。直接用动画序列固然可以，不过用我们在[UE4/UE5 骨骼动画 高级运动系统 走跑混合初步 - 知乎 (zhihu.com)](https://zhuanlan.zhihu.com/p/482748722)中提到的做法。
![[编程/UE/功能模块/Image/角色动画相关/01f8923c96d4f21866d16a6064de0b19_MD5.png]]
